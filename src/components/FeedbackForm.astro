---
// Feedback Form Component
---

<div class="feedback-form-container">
  <div class="bg-background border border-border rounded-lg p-6 shadow-sm">
    <h3 class="text-xl font-bold text-accent mb-2">Suggest New Tools</h3>
    <p class="text-sm text-foreground/70 mb-4">
      What new tools do you need? Suggest to us, and we'll try to implement them on the website.
    </p>

    <!-- Feedback Form -->
    <form id="feedback-form" class="space-y-4">
      <!-- Suggestion Text Area -->
      <div>
        <label for="suggestion" class="block text-sm font-medium text-foreground mb-2">
          Your Suggestion <span class="text-red-500">*</span>
        </label>
        <textarea
          id="suggestion"
          name="suggestion"
          rows="4"
          placeholder="Enter your suggestion..."
          class="w-full px-3 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent resize-none text-sm"
          required
          minlength="10"
          maxlength="500"
        ></textarea>
        <div class="flex justify-between text-xs text-foreground/60 mt-1">
          <span>Minimum 10 characters</span>
          <span id="char-count">0/500</span>
        </div>
      </div>

      <!-- Email Field (Optional) -->
      <div>
        <label for="email" class="block text-sm font-medium text-foreground mb-2">
          Email Address <span class="text-foreground/60">(optional)</span>
        </label>
        <input
          type="email"
          id="email"
          name="email"
          placeholder="your.email@example.com"
          class="w-full px-3 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent text-sm"
        />
        <p class="text-xs text-foreground/60 mt-1">
          Only fill in if you want us to reply
        </p>
      </div>

      <!-- Privacy Agreement -->
      <div class="space-y-2">
        <label class="flex items-start space-x-2 text-sm">
          <input
            type="checkbox"
            id="privacy-agreement"
            name="privacy-agreement"
            required
            class="mt-0.5 h-4 w-4 text-accent focus:ring-accent border-border rounded"
          />
          <span class="text-foreground/80">
            I agree to the <button type="button" id="privacy-toggle" class="text-accent hover:underline">Privacy Policy</button> <span class="text-red-500">*</span>
          </span>
        </label>

        <!-- Privacy Policy (Expandable) -->
        <div id="privacy-policy" class="hidden bg-muted/20 p-3 rounded text-xs text-foreground/70">
          <h4 class="font-medium mb-2">Privacy Commitment:</h4>
          <ul class="space-y-1 list-disc list-inside">
            <li>We promise to protect the confidentiality of your information</li>
            <li>We will never share or leak your data</li>
            <li>Email addresses are only used to reply to your suggestions (if provided)</li>
            <li>You can request deletion of your data at any time</li>
          </ul>
        </div>
      </div>

      <!-- Submit Button -->
      <button
        type="submit"
        id="submit-btn"
        class="w-full bg-accent text-background py-2 px-4 rounded-lg hover:bg-accent/90 transition-colors font-medium text-sm disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Send Feedback
      </button>
    </form>

    <!-- Status Messages -->
    <div id="form-status" class="mt-4 hidden">
      <div id="success-message" class="hidden bg-green-50 border border-green-200 text-green-800 px-3 py-2 rounded text-sm">
        ✅ Thank you for your feedback! We have received your suggestion.
      </div>
      <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-800 px-3 py-2 rounded text-sm">
        ❌ <span id="error-text">Submission failed, please try again later.</span>
      </div>
    </div>
  </div>
</div>

<script>
  function initFeedbackForm() {
    const form = document.getElementById('feedback-form') as HTMLFormElement;
    const suggestionTextarea = document.getElementById('suggestion') as HTMLTextAreaElement;
    const charCount = document.getElementById('char-count') as HTMLElement;
    const privacyToggle = document.getElementById('privacy-toggle') as HTMLButtonElement;
    const privacyPolicy = document.getElementById('privacy-policy') as HTMLElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const formStatus = document.getElementById('form-status') as HTMLElement;
    const successMessage = document.getElementById('success-message') as HTMLElement;
    const errorMessage = document.getElementById('error-message') as HTMLElement;
    const errorText = document.getElementById('error-text') as HTMLElement;

    // Character count update
    suggestionTextarea?.addEventListener('input', () => {
      const length = suggestionTextarea.value.length;
      charCount.textContent = `${length}/500`;

      if (length < 10) {
        charCount.classList.add('text-red-500');
        charCount.classList.remove('text-foreground/60');
      } else {
        charCount.classList.remove('text-red-500');
        charCount.classList.add('text-foreground/60');
      }
    });

    // Privacy policy toggle
    privacyToggle?.addEventListener('click', (e) => {
      e.preventDefault();
      privacyPolicy.classList.toggle('hidden');
    });

    // Form submission
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const suggestion = formData.get('suggestion') as string;
      const email = formData.get('email') as string;
      const privacyAgreement = formData.get('privacy-agreement');

      // Validation
      if (!suggestion || suggestion.length < 10) {
        showError('Suggestion must be at least 10 characters long');
        return;
      }

      if (!privacyAgreement) {
        showError('Please agree to the privacy policy');
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      hideMessages();

      try {
        // Submit to Supabase
        console.log('Submitting feedback...', {
          suggestion: suggestion.trim(),
          email: email.trim() || null,
          timestamp: new Date().toISOString(),
          user_agent: navigator.userAgent,
          page_url: window.location.href
        });

        const response = await fetch('/api/feedback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            suggestion: suggestion.trim(),
            email: email.trim() || null,
            timestamp: new Date().toISOString(),
            user_agent: navigator.userAgent,
            page_url: window.location.href
          })
        });

        console.log('Response status:', response.status);
        console.log('Response headers:', Object.fromEntries(response.headers.entries()));

        if (response.ok) {
          const successData = await response.json();
          console.log('Success response:', successData);
          showSuccess();
          form.reset();
          charCount.textContent = '0/500';
        } else {
          const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
          console.error('Error response:', errorData);
          showError(errorData.message || 'Submission failed, please try again later');
        }
      } catch (error) {
        const errorMessage = error instanceof Error ? error.message : 'Unknown error';
        console.error('Feedback submission error details:', {
          message: errorMessage,
          stack: error instanceof Error ? error.stack : undefined,
          name: error instanceof Error ? error.name : 'Unknown',
          error: error
        });
        showError(`Network error: ${errorMessage}. Please check your connection and try again.`);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Feedback';
      }
    });

    function showSuccess() {
      formStatus.classList.remove('hidden');
      successMessage.classList.remove('hidden');
      errorMessage.classList.add('hidden');
    }

    function showError(message: string) {
      formStatus.classList.remove('hidden');
      errorMessage.classList.remove('hidden');
      successMessage.classList.add('hidden');
      errorText.textContent = message;
    }

    function hideMessages() {
      formStatus.classList.add('hidden');
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
    }
  }

  // Initialize on page load
  initFeedbackForm();

  // Re-initialize on view transitions
  document.addEventListener('astro:after-swap', initFeedbackForm);
</script>

<style>
  .feedback-form-container {
    position: sticky;
    top: 2rem;
  }
</style>
